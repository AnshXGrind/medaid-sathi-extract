name: CI Security, Quality & Compliance Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  security-scan:
    name: ğŸ”’ Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection
      
    - name: ï¿½ Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        extra_args: --only-verified --json --fail
        
    - name: ï¿½ï¸ GitLeaks secret detection
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ” SAST scan with Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/typescript
          p/python
  
  code-quality:
    name: ğŸ“Š Code Quality & Type Safety
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ï¿½ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ï¿½ Install dependencies
      run: npm ci
      
    - name: ğŸ” TypeScript type checking
      run: npx tsc --noEmit
      
    - name: ğŸ§¹ ESLint
      run: npm run lint
      
    - name: ğŸ“Š Build check
      run: npm run build
      env:
        # Dummy values for CI build validation
        VITE_SUPABASE_URL: https://ci-test.supabase.co
        VITE_SUPABASE_ANON_KEY: dummy-key-for-build-validation-only
        VITE_AADHAAR_HMAC_SECRET: dummy-secret-must-be-minimum-64-characters-long-for-validation
        VITE_ENCRYPTION_MASTER_KEY: dummy-master-key-must-be-minimum-64-characters-long-validation
        VITE_JWT_SECRET: dummy-jwt-secret-must-be-minimum-64-characters-long-validation
        NODE_ENV: production
        
  dependency-audit:
    name: ğŸ”’ Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”’ NPM security audit
      run: npm audit --audit-level=high
      continue-on-error: true
      
    - name: ğŸ“‹ Dependency Review (PRs only)
      uses: actions/dependency-review-action@v4
      if: github.event_name == 'pull_request'
      
    - name: ğŸ›¡ï¸ Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        
    - name: ğŸ“¤ Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
      
  backend-security:
    name: ğŸ Backend Security (Python)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install backend dependencies
      working-directory: ./backend-modules
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety pip-audit
        
    - name: ğŸ”’ Bandit security scan
      working-directory: ./backend-modules
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -ll
      
    - name: ğŸ” Python dependency vulnerability scan (Safety)
      working-directory: ./backend-modules
      run: safety check --json || true
      
    - name: ğŸ›¡ï¸ pip-audit vulnerability check
      working-directory: ./backend-modules
      run: pip-audit --desc || true
      
  compliance-check:
    name: âš–ï¸ GDPR/DPDP Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ï¿½ Checkout code
      uses: actions/checkout@v4
      
    - name: âœ… Verify security config files exist
      run: |
        test -f src/config/security.ts || (echo "security.ts missing" && exit 1)
        test -f src/config/privacy.ts || (echo "privacy.ts missing" && exit 1)
        test -f .env.example || (echo ".env.example missing" && exit 1)
        test -f SECURITY.md || (echo "SECURITY.md missing" && exit 1)
        echo "âœ… All required security files present"
        
    - name: âœ… Check .gitignore contains sensitive files
      run: |
        grep -q "\.env" .gitignore || (echo ".env not in .gitignore" && exit 1)
        grep -q "\.env\.local" .gitignore || (echo ".env.local not in .gitignore" && exit 1)
        echo "âœ… .gitignore properly configured"
        
    - name: âœ… Verify no hardcoded secrets
      run: |
        ! grep -r "AKIAI" . --exclude-dir=node_modules --exclude-dir=.git || (echo "AWS key found" && exit 1)
        ! grep -r "sk-[a-zA-Z0-9]{20,}" . --exclude-dir=node_modules --exclude-dir=.git || (echo "OpenAI key found" && exit 1)
        echo "âœ… No hardcoded secrets detected"
        
  test-suite:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run tests (when implemented)
      run: npm test || echo "Tests not yet implemented"
      continue-on-error: true
      
  docker-security:
    name: ğŸ³ Docker Security Scan
    runs-on: ubuntu-latest
    if: hashFiles('Dockerfile') != ''
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Build Docker image
      run: docker build -t medaid-sathi:ci .
      
    - name: ğŸ” Scan Docker image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'medaid-sathi:ci'
        format: 'sarif'
        output: 'docker-trivy-results.sarif'
        
  summary:
    name: ğŸ“ CI Summary
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, dependency-audit, backend-security, compliance-check]
    if: always()
    
    steps:
    - name: ğŸ“Š Check all jobs status
      run: |
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Dependency Audit: ${{ needs.dependency-audit.result }}"
        echo "Backend Security: ${{ needs.backend-security.result }}"
        echo "Compliance Check: ${{ needs.compliance-check.result }}"
        
        if [ "${{ needs.security-scan.result }}" != "success" ] || \
           [ "${{ needs.code-quality.result }}" != "success" ] || \
           [ "${{ needs.compliance-check.result }}" != "success" ]; then
          echo "âŒ CI checks failed"
          exit 1
        fi
        
        echo "âœ… All critical CI checks passed!"
