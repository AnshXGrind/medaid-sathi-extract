<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Connection Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background-color: #0056b3; }
    pre { background-color: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>üîê Supabase Connection Test</h1>
  <div id="results"></div>
  
  <h2>Test Actions</h2>
  <button onclick="testConnection()">Test Connection</button>
  <button onclick="testSignIn()">Test Sign In</button>
  <button onclick="testSession()">Check Session</button>
  
  <h2>Manual Test Sign In</h2>
  <input type="email" id="email" placeholder="Email" style="padding: 8px; width: 300px;">
  <input type="password" id="password" placeholder="Password" style="padding: 8px; width: 300px;">
  <button onclick="manualSignIn()">Sign In</button>

  <script>
    const SUPABASE_URL = 'https://tdfkrllvxlrukdzsiwjd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkZmtybGx2eGxydWtkenNpd2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MDM3NTEsImV4cCI6MjA3NzI3OTc1MX0.vn8vmT2zmfgxiFlFkUg_XrjbIBlCGkARCMzRcT8hIpI';
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const results = document.getElementById('results');
    
    function addResult(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = message;
      results.appendChild(div);
      console.log(message);
    }
    
    async function testConnection() {
      results.innerHTML = '';
      addResult('üîç Testing Supabase Connection...', 'info');
      
      try {
        // Test 1: Check if client is created
        addResult(`‚úÖ Supabase client created successfully`, 'success');
        addResult(`üìç URL: ${SUPABASE_URL}`, 'info');
        addResult(`üîë Anon Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...`, 'info');
        
        // Test 2: Try to get session
        const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
          addResult(`‚ùå Session check failed: ${sessionError.message}`, 'error');
        } else {
          addResult(`‚úÖ Session check successful`, 'success');
          addResult(`Session: ${sessionData.session ? 'Active' : 'None'}`, 'info');
        }
        
        // Test 3: Try a basic query
        const { data, error } = await supabaseClient
          .from('profiles')
          .select('count')
          .limit(1);
        
        if (error) {
          addResult(`‚ö†Ô∏è Database query test: ${error.message}`, 'error');
        } else {
          addResult(`‚úÖ Database connection successful`, 'success');
        }
        
      } catch (error) {
        addResult(`‚ùå Connection test failed: ${error.message}`, 'error');
        addResult(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
      }
    }
    
    async function testSignIn() {
      results.innerHTML = '';
      addResult('üîê Testing Sign In (with test credentials)...', 'info');
      
      try {
        const testEmail = 'test@example.com';
        const testPassword = 'test123456';
        
        addResult(`Attempting to sign in with: ${testEmail}`, 'info');
        
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: testEmail,
          password: testPassword
        });
        
        if (error) {
          addResult(`Expected error (test account doesn't exist): ${error.message}`, 'info');
          addResult('‚úÖ Sign-in endpoint is reachable', 'success');
        } else {
          addResult(`‚úÖ Sign in successful!`, 'success');
          addResult(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
        }
        
      } catch (error) {
        addResult(`‚ùå Sign in test failed: ${error.message}`, 'error');
        addResult(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
      }
    }
    
    async function testSession() {
      results.innerHTML = '';
      addResult('üìã Checking Current Session...', 'info');
      
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) {
          addResult(`‚ùå Error: ${error.message}`, 'error');
        } else if (session) {
          addResult(`‚úÖ Active session found!`, 'success');
          addResult(`<pre>${JSON.stringify({
            user: session.user.email,
            role: session.user.user_metadata?.role,
            expires_at: new Date(session.expires_at * 1000).toLocaleString()
          }, null, 2)}</pre>`, 'success');
        } else {
          addResult(`‚ÑπÔ∏è No active session`, 'info');
        }
        
      } catch (error) {
        addResult(`‚ùå Session check failed: ${error.message}`, 'error');
      }
    }
    
    async function manualSignIn() {
      results.innerHTML = '';
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        addResult('‚ùå Please enter both email and password', 'error');
        return;
      }
      
      addResult(`üîê Attempting to sign in as: ${email}...`, 'info');
      
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) {
          addResult(`‚ùå Sign in failed: ${error.message}`, 'error');
        } else {
          addResult(`‚úÖ Sign in successful!`, 'success');
          addResult(`<pre>${JSON.stringify({
            email: data.user.email,
            role: data.user.user_metadata?.role,
            id: data.user.id
          }, null, 2)}</pre>`, 'success');
        }
        
      } catch (error) {
        addResult(`‚ùå Sign in error: ${error.message}`, 'error');
      }
    }
    
    // Auto-run connection test on load
    window.onload = () => {
      testConnection();
    };
  </script>
</body>
</html>
